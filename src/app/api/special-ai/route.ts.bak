import { NextRequest, NextResponse } from "next/server";
import OpenAI from "openai";

// <SECURITY_REVIEW>
// - Validate user input before sending to API
// - Do not expose OpenAI API key to client
// - Handle API/network errors gracefully
// - Rate limiting and abuse prevention should be considered for production
// </SECURITY_REVIEW>

// OpenAI ?´ë¼?´ì–¸??ì´ˆê¸°??
const getOpenAIClient = () => {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    throw new Error("OpenAI API key not configured");
  }
  return new OpenAI({ apiKey });
};

export async function POST(req: NextRequest) {
  try {
    const { role, input, options } = await req.json();
    
    if (!role || !input) {
      return NextResponse.json({ error: "Missing required fields: role and input" }, { status: 400 });
    }
    
    let systemMessage = "";
    
    
    // ??• ???°ë¥¸ ?œìŠ¤??ë©”ì‹œì§€ ?¤ì •
    switch (role) {
      case "emoji-generator":
        systemMessage = "You will be provided with text, and your task is to translate it into emojis. Do not use any regular text. Do your best with emojis only.";
        break;
        
      case "color-generator":
        systemMessage = "You will be provided with a description of a mood, and your task is to generate the CSS code for a color that matches it. Write your output in JSON with a single key called \"css_code\".";
        
        break;
        
      case "translator":
        const targetLanguage = options?.targetLanguage || "english";
        let languageName = "";
        
        switch (targetLanguage) {
          case "english":
            languageName = "?ì–´";
            break;
          case "japanese":
            languageName = "?¼ë³¸??;
            break;
          case "chinese":
            languageName = "ì¤‘êµ­??;
            break;
          default:
            languageName = "?ì–´";
        }
        
        systemMessage = `You will be provided with a sentence in Korean, and your task is to translate it into ${targetLanguage}. Only provide the translated text without any explanations.`;
        break;
        
      case "custom-ai":
        systemMessage = options?.systemMessage || "You are a helpful assistant.";
        break;
        
      default:
        return NextResponse.json({ error: "Invalid role specified" }, { status: 400 });
    }
    
    const client = getOpenAIClient();
    
    const response = await client.chat.completions.create({
      model: "gpt-4",  // ?ëŠ” ?¬ìš© ê°€?¥í•œ ìµœì‹  ëª¨ë¸
      messages: [
        { role: "system", content: systemMessage },
        { role: "user", content: input }
      ],
      temperature: role === "emoji-generator" ? 0.7 : 0.3,  // ?´ëª¨ì§€??ì¡°ê¸ˆ ??ì°½ì˜?ìœ¼ë¡?
    });
    
    const result = response.choices[0]?.message?.content || "";
    
    // ?‰ìƒ ?ì„±ê¸?ê²½ìš° JSON ?•ì‹ ì²˜ë¦¬
    if (role === "color-generator") {
      try {
        // ?‘ë‹µ??JSON ?•ì‹???„ë‹ ê²½ìš°ë¥??€ë¹„í•œ ì²˜ë¦¬
        let colorData = result;
        
        // ë¬¸ì?´ì—??JSON ë¶€ë¶?ì¶”ì¶œ ?œë„
        if (!result.trim().startsWith('{')) {
          const jsonMatch = result.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            colorData = jsonMatch[0];
          }
        }
        
        // JSON ?Œì‹± ?œë„
        const parsedResult = JSON.parse(colorData);
        return NextResponse.json({ result: parsedResult });
      } catch \(_e\) {
        // JSON ?Œì‹± ?¤íŒ¨ ???¼ë°˜ ?ìŠ¤?¸ë¡œ ë°˜í™˜
        return NextResponse.json({ 
          result: { css_code: "#7B68EE" }, // ê¸°ë³¸ ?‰ìƒ ?œê³µ
          error: "Failed to parse color data"
        });
      }
    }
    
    return NextResponse.json({ result });
  } catch (e: unknown) {
    const errorMessage = e instanceof Error ? e.message : "Unknown error";
    return NextResponse.json({ error: errorMessage }, { status: 500 });
  }
} 
